services:
  app:
    container_name: metamcp
    build:
      context: .
      dockerfile: Dockerfile.metamcp
    pull_policy: always
    env_file:
      - .env
    # With host networking, ports are exposed directly
    # ports:
    #   - "12008:12008"
    environment:
      # Environment variables for stdio MCP servers
      HOME: "/home/${USER_NAME}"
      POSTGRES_HOST: localhost
      DATABASE_URL: postgresql://metamcp_user:m3t4mcp@localhost:5432/metamcp_db
      APP_URL: http://localhost:12008
      NEXT_PUBLIC_APP_URL: http://localhost:12008
      BETTER_AUTH_SECRET: your-super-secret-and-very-long-key-here
      TRANSFORM_LOCALHOST_TO_DOCKER_INTERNAL: "true"
    # Use host networking instead of bridged network
    network_mode: "host"
    depends_on:
      postgres:
        condition: service_healthy
    restart: "always"

    volumes:
      # Add docker socket for MCP servers that need to spawn containers
      - /var/run/docker.sock:/var/run/docker.sock:rw
      # Mount home directory for proper file access with exact same path as host
      - ${USER_HOME}:${USER_HOME}:rw
    # Remove networks section since we're using host networking
    # networks:
    #   - metamcp-network
    # Add user and group IDs to match host
    user: "${HOST_UID}:${HOST_GID}"
    group_add:
      - "${DOCKER_GID:-999}"

  postgres:
    image: postgres:16-alpine
    container_name: metamcp-pg
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-metamcp_db}
      POSTGRES_USER: ${POSTGRES_USER:-metamcp_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-m3t4mcp}
    # With host networking, expose port directly
    # ports:
    #   - "${POSTGRES_EXTERNAL_PORT:-9433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-metamcp_user} -d ${POSTGRES_DB:-metamcp_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Use host networking
    network_mode: "host"

volumes:
  postgres_data:
    driver: local

# Remove networks section since we're using host networking
# networks:
#   metamcp-network:
#   driver: bridge